<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script>
        class RequestLimit {
            constructor(limit) {
                this.limit = Number(limit) || 2;
                this.blockQueue = [];
                this.currentReqNumber = 0;
            }

            async request(url) {
                const _realReq = () => new Promise(function (resolve, reject) { // 这个promise是为了模拟请求
                    console.log(url, 'beginning')
                    setTimeout(() => {
                        resolve();
                        console.log(url, 'ending')
                    }, Math.random() * 10 * 1000);
                });
                const p = new Promise((resolve, reject) => {
                    this.blockQueue.push([_realReq, [resolve, reject]])
                })
                this._handlerReq();

                return p;
            }

            async _handlerReq() {
                if (this.currentReqNumber < this.limit && this.blockQueue.length) {
                    this.currentReqNumber++;
                    const [_realReq, [resolve, reject]] = this.blockQueue.shift();
                    _realReq().then(resolve, reject).finally(() => {
                        this.currentReqNumber--;
                        this._handlerReq();
                    });
                }
            }
        }

        /// 测试 --------------------------
        const requestLimit = new RequestLimit(2);
        for (let i = 0; i < 8; i++) {
            requestLimit.request(i);
        }
    </script>
</head>

<body>
</body>

</html>